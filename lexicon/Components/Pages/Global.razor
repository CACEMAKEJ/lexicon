@page "/global"
@using lexicon.Components.Data
@inject ITranslationRepo Repo
@rendermode InteractiveServer
<div class="width-limiter container d-flex flex-column justify-content-center mx-auto py-4 p-1">
    <h2 style="color: white;">Global Translation History</h2>
    <select @onchange="FilterByLanguage">
        <option value="">-- Filter by language --</option>
        @foreach (var lang in languages) {
            <option value="@lang">@lang</option>
        }
    </select>

    @if (translations == null) {
        <p style="color: white;">Loading...</p>
    }
    else if (translations.Count == 0) {
        <p>No translations yet.</p>
    }
    else {
        <ul class="px-2" style="list-style-type: none;">
            @foreach (var t in translations) {
                <div class="mt-2 p-4" style="background-color:#2f3542; border-radius:14px; border:1px solid #3f4654; color:white; box-shadow:0 4px 14px rgba(0,0,0,0.4);">
                    <li >
                        <b style="color: white;">@t.SourceLanguage → @t.TargetLanguage:</b>
                        <span style="color: white;">@t.OriginalText</span> → <i style="color: white;">@t.TranslatedText</i>
                        <p style="color: white;">(@t.Timestamp.ToLocalTime())</p>
                    </li>
                </div>
            }
        </ul>
    }
</div>

@code {
    private List<TranslationRecord> translations;
    private List<string> languages = new();
    private string selectedLanguage = "";

    protected override async Task OnInitializedAsync() {
        translations = await Repo.GetRecentAsync(50);
        languages = translations.Select(t => t.SourceLanguage).Distinct().ToList();
    }

    private async Task FilterByLanguage(ChangeEventArgs e) {
        selectedLanguage = e.Value?.ToString()?.Trim().ToLower();

        if (string.IsNullOrEmpty(selectedLanguage))
            translations = await Repo.GetRecentAsync(50);
        else
            translations = await Repo.GetByLanguageAsync(selectedLanguage);
        StateHasChanged();
    }
}